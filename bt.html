<!DOCTYPE html>
<html>
<head>
    <title>Bluetooth Connection Example</title>
</head>
<body>
    <button id="connect">Connect to Bluetooth Device</button>
    <input type="text" id="dataToSend" placeholder="Enter data to send" />
    <button id="sendData">Send Data</button>

    <script>
        document.getElementById('connect').addEventListener('click', async () => {
            try {
                const device = await navigator.bluetooth.requestDevice({
                    acceptAllDevices: true,
                    // optionalServices: [0x1800,0x1801] 
                });

                device.addEventListener('gattserverdisconnected', onDisconnected);
                console.log('Connecting to the device...');
                const server = await device.gatt.connect();
                console.log('Connected to', device.name);

                // Store the device for use later       
                window.connectedDevice = device;
            } catch (error) {
                console.error('Error:', error);
            }
        });

        document.getElementById('sendData').addEventListener('click', async () => {
            if (!window.connectedDevice || !window.connectedDevice.gatt.connected) {
                return alert('Device is not connected. Please connect to a device first.');
            }

            try {
                const serviceUuid = 0x180A; 
                const characteristicUuid = '49535343-1E4D-4BD9BA61-23C647249616'; 
                const dataToSend = document.getElementById('dataToSend').value;
                const data = new TextEncoder().encode(dataToSend); // Convert string to bytes

                const server = await window.connectedDevice.gatt.connect();
                const service = await server.getPrimaryService(serviceUuid);
                const characteristic = await service.getCharacteristic(characteristicUuid);
                await characteristic.writeValue(data);
                console.log('Data sent:', dataToSend);
            } catch (error) {
                console.error('Error:', error);
            }
        });

        function onDisconnected(event) {
            const device = event.target;
            console.log(`Device ${device.name} is disconnected.`);
        }
    </script>
</body>
</html>
